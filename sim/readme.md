# 2ndコアシミュレータver1.1α, アセンブラ、FPUシミュ，変換ツール

※バイナリファイルでの実行に注意が必要です．詳細は注意へ
※ブレークポイントの仕様を使いやすく(?)変更しました．詳細は`bs`のコマンドの説明へ

## 使用方法
### シミュレータ
makeコマンドでmainファイルを作成し、「`./main fib.s`」のように実行ファイルを入力としてください。（複数ファイルで実行する場合は，下記項目注意参照）
なお，バイナリファイルで実行したい場合は，`-b`オプションをつければ実行できます．
`-c1, -c2`のように，`-c[ウェイ数]`のオプションをつけるとキャッシュのウェイ数を変えられます(デフォルトは1)．
その後、以下のコマンドを実行してアセンブリの挙動を確かめられます。
- `a`   ... (all) 全実行
- `ba`   ... (back) 1命令もとに戻す（1024回まで）
- `bs [lineN]` ... (break set) `[lineN]`行目にブレークポイントを追加
    - アセンブラが入力の時 ... ファイルの行数で指定
    - 機械語が入力の時（バイナリ，テキスト問わず） ... エントリポイント用に追加されるjalを0インデックスとするインデックスで指定
- `bl`  ... (break list) ブレークポイントのリストを表示
- `bd [lineN]` ... (break delete) `[lineN]`行目のブレークポイントを削除
- `c`   ... (cache) キャッシュの情報を表示
- `dif` ... (difference) 現在のファイルを最初から実行し，命令の実行履歴をファイルに出力する
    - すでにそのファイルが存在するときは，それと内容を比べ，違いを検出する．
- `i`   ... (info) これまでの実行命令数などの情報を表示
- `io`  ... (mmio) MMIOで受信したバイト数，送信したバイト数を見ることができる．また，受信した文字を表示することも可能．
- `ml`  ... (mem list) メモリの使用している領域すべてを表示する
- `mr [address] ([wordN])` ... `[address]`に位置するメモリからMSB方向へ`[wordN]`ワード（省略した場合、1ワード）のメモリを表示する(16進表示) 
    - `[address]`は`0x`などの接頭辞をつけることで進法を変えられる
- `n ([rr])`   ... (next) 次の命令のみを実行
    - オプションに`-r`, `-rh`などと打つと，次の命令を実行した後に自動で`rr`, `rr -h`を実行します．
- `nb`  ... (next break) 次のブレークポイントまで実行
- `rr ([regName]) (-[base], -[signed])`  ... (register read) `[regName]`のレジスタを`[base]`進法、符号の有無を`[signed]`で表示。
    - `[regname]` ... デフォルトは全レジスタの表示
    - `[base]`    ... b, o, d, h (デフォルトはd)
    - `[signed]`  ... uで符号なしとして表示（デフォルトは符号付） 
- `out` ... (output) MMIOで送信した内容をdata/output.ppmへ出力する．終了時に自動で実行される．
- `rw　[regName] [value] (-[base])`  ... (register write) `[regName]`のレジスタに`[base]`進法で`[value]`の値を書き込む。`[base]`はb, o, d, h (デフォルトはd)から選ぶ。unsignedは実装していません。
    - 浮動小数点レジスタに対しては-fでfloat値を書き込めます
- `re`  ... (reset) レジスタ群、統計情報などのデータをリセットして命令を実行前の状態に戻す
    - ブレークポイントはリセットされないように(v2.5以降)
    - 連続した領域はまとめて表示するようにしてある

#### MMIO
以下のアドレスへのバイトアクセスはMMIOとして解釈されます．
- 0x100000 - 3 ... recvのvalidビット．データが読み込める状態の時1をロードでき, 準備中，あるいはデータがもうないときは0をロードする．書き込みするとエラー．
- 0x100000 - 2 ... recv. ここに`lbu`することでデータを順にロードできる．validが0のときは0をロードする．書き込みするとエラー．
- 0x100000 - 1 ... send. ここに`sb`することで，データを送ることができる．送ったデータはsimulatorを`quit`したのちにdata/output.ppmファイルとして出力される．

※データはdata/contest.sldファイルから読み込みます(存在しない場合エラー)
※sims/simulator.hppのMMIO_VALID ~ MMIO_SENDの値を変えることで(制限の範囲内で)自由にアドレスを変更できます．
### アセンブラ
`make assembler`でassemblerファイルを作り、実行してください。

実行時，出力について次を指定するとその形式で出力されます．
- `-b`   ... (binary) バイナリ形式でファイルに出力されます．

以上で，実行すると，`./test/`内の`.s`ファイルが`.s.out`ファイルとして全てコンパイルされます．


### FPU
`make fpuChecker`でfpuCheckerファイルを作成し、実行してください。ランダムに1000*2の浮動小数点を作り、ともに正規化されており、かつその計算結果が正規化数の時のみ、FPUのシミュレータで計算を実行し、difをとり、表示します。

### 変換ツール
`make tools`でtoolsファイルを作成し，実行してください．変換したい値を入れると，int, float，byte配列に変換した場合と，floatレジスタにロードする命令列を表示します．
    - int値として読み込ませたい時は`-b, -h, -d, -o`などのオプションを指定してください．


## 注意
- g++, makeを実行できる環境が必要です。（aptなどでインストールしてください。）
- intが4バイトであることを暗黙に用いているので注意してください
- ~~nextはコメントやラベルをスキップしていましたが、しないように変更しました。~~
- 命令、float、intは4バイトアラインされたアドレスのみで読み書きできます．
- 特にエントリポイントを指定しない場合，実行時引数で最も先頭のファイルの最初の命令から始めます．
- 複数ファイルでシミュレーションする場合，引数としてファイルを渡す際に，エントリポイントのあるファイルは一番最後に配置してください．
    - アセンブラをそのままつなげて一つのファイルのように扱うので，もしこうしない場合，エントリポイントのあるファイルの全命令を実行後，つぎのファイルの先頭の命令を実行してしまいます．
- コメント，ラベルはnopに変換していましたが，無視するように変更しました．
    - アドレスを用いたジャンプを行っている場合，以前のバージョンと挙動が変わることがあります．
- バイナリファイルで実行する際は，ver2.4以降かそうでないかで使う形式が異なります．
    - ver2.4より前 ... 使うバイナリ(?)ファイルは assemblerのオプションなしで生成されるテキストファイル形式のものです．
    - ver2.4以降   ... 使うバイナリファイルはassemblerの`-b`オプションで生成されるバイナリファイルです．
        - deassembler, parserの`USE_REAL_BINARY`をfalseにすることで旧形式でも読み込めます．
- `-sp` のオプションをつけるとパラメータ探索モードになります(シミュ係用)．
## ディレクトリ，ファイルについての説明
- data ... MMIOの入出力ファイルを格納
    - contest.sld ... シミュレータ側へデータが送信されるファイル．ないとエラー．
    - output.ppm  ... MMIOにより送信されたデータ．正常に終了した時に生成される．
- params ... FPU用のパラメータを格納．ないとエラー．
- test ... テスト用のアセンブラを格納．

## アセンブリの仕様
- `.global `から始まる文も基本的にはコメントとみなすが，特殊な指令は別
    - `.global	min_caml_start`　という文があれば，その下のアドレスをエントリポイントとして設定する
    - これを使わない場合，先頭には`nop`が追加されます．
- ラベル名に使用可能なのはa-Z, 0-9, 記号は_, .のみ。大文字小文字区別する。
    - ただし，内部ではエントリポイントに`"+ENTRY"`というラベルをつけている
    - 同一ラベルがあった場合、パース時にエラーを吐く
- ラベル名の後ろにはコロンをつける
    - ラベルとコロンの間に空白文字が合ってもよいが、ラベル登録時に空白文字は消す
- 行が空白文字（タブ、半角空白）から始まる場合は命令とみなす
    - インデントの数は自由
- オペコードは小文字のみ
    - 現在対応しているのはadd, addi, nop, beq, blt, jの６つ
- レジスタはx0(zero), x1~x31, pcの32+1個
- シャープの後ろはコメント

## その他留意点
- ALUのオーバーフローは処理しない（RISC-Vの仕様？）
- jalr, jrでのジャンプ先は4バイトアラインしたアドレスしか認めない（simulator.cpp doControlの実装参照）
- `sw`, `lw`などは4バイトアラインされたアドレスを指定しないとエラーをはきます

## todo


## バージョン履歴
- 1.00 ... 2ndシミュ完成
- 1.10 ... 1st完動時のシミュとマージ

